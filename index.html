<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒãƒ£å ã„ - å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&family=Zen+Maru+Gothic:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B4789;
            --secondary: #E6D5E8;
            --accent: #FFD700;
            --dark: #2C1B3D;
            --light: #FAF7FB;
            --text: #3D2645;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background: linear-gradient(135deg, #1e1140 0%, #3d2463 50%, #1e1140 100%);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 71, 137, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 1s ease-out;
        }

        h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            letter-spacing: 0.05em;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--secondary);
            font-weight: 300;
            letter-spacing: 0.1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 1.1rem;
            font-family: 'Noto Serif JP', serif;
        }

        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Zen Maru Gothic', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 71, 137, 0.1);
        }

        .optional {
            font-size: 0.85rem;
            color: #999;
            font-weight: 400;
            margin-left: 5px;
        }

        button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), #6B3567);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Serif JP', serif;
            letter-spacing: 0.05em;
            box-shadow: 0 10px 30px rgba(139, 71, 137, 0.3);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(139, 71, 137, 0.4);
        }

        .result {
            display: none;
            animation: fadeInUp 1s ease-out;
        }

        .result.show {
            display: block;
        }

        .lucky-time {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .lucky-time h2 {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }

        .time-slot h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .time-slot p {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Noto Serif JP', serif;
        }

        .score {
            display: inline-block;
            background: white;
            color: var(--primary);
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .divination-section {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }

        .divination-section h3 {
            font-family: 'Noto Serif JP', serif;
            color: var(--primary);
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .divination-section p {
            line-height: 1.8;
            color: var(--text);
        }

        .lucky-action {
            background: linear-gradient(135deg, var(--secondary), #D4BDD6);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .lucky-action h3 {
            font-family: 'Noto Serif JP', serif;
            color: var(--primary);
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .lucky-action ul {
            list-style: none;
            padding-left: 0;
        }

        .lucky-action li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            line-height: 1.6;
        }

        .lucky-action li::before {
            content: 'âœ¨';
            position: absolute;
            left: 0;
            top: 10px;
        }

        .download-pdf-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Serif JP', serif;
            letter-spacing: 0.05em;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .download-pdf-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .download-pdf-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .download-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
        }

        .lucky-girl {
            text-align: center;
            margin: 30px 0;
            animation: fadeInUp 1.5s ease-out;
        }

        .lucky-girl img {
            max-width: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(139, 71, 137, 0.3);
            border: 5px solid var(--accent);
        }

        .lucky-girl h3 {
            font-family: 'Noto Serif JP', serif;
            color: var(--primary);
            font-size: 1.5rem;
            margin: 20px 0 10px;
            font-weight: 700;
        }

        .lucky-girl p {
            color: var(--text);
            font-size: 1.1rem;
            line-height: 1.8;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(139, 71, 137, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .card {
                padding: 25px;
            }

            .lucky-time h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div class="container">
        <header>
            <h1>ğŸ”® ã‚¬ãƒãƒ£å ã„</h1>
            <p class="subtitle">å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ  by ã‚¯ãƒˆã¡ã‚ƒã‚“</p>
        </header>

        <div class="card">
            <form id="fortuneForm">
                <div class="form-group">
                    <label for="gameTitle">ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <select id="gameTitle" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ã‚¦ãƒå¨˜">ã‚¦ãƒå¨˜ ãƒ—ãƒªãƒ†ã‚£ãƒ¼ãƒ€ãƒ¼ãƒ“ãƒ¼</option>
                        <option value="ãƒ–ãƒ«ã‚¢ã‚«">ãƒ–ãƒ«ãƒ¼ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                        <option value="åŸç¥">åŸç¥</option>
                        <option value="NIKKE">å‹åˆ©ã®å¥³ç¥ï¼šNIKKE</option>
                        <option value="å´©å£Šã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ«">å´©å£Šï¼šã‚¹ã‚¿ãƒ¼ãƒ¬ã‚¤ãƒ«</option>
                        <option value="é³´æ½®">é³´æ½®</option>
                        <option value="Fate/GO">Fate/Grand Order</option>
                        <option value="ãƒ—ãƒªã‚³ãƒR">ãƒ—ãƒªãƒ³ã‚»ã‚¹ã‚³ãƒã‚¯ãƒˆï¼Re:Dive</option>
                        <option value="ã‚°ãƒ©ãƒ–ãƒ«">ã‚°ãƒ©ãƒ³ãƒ–ãƒ«ãƒ¼ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option>
                        <option value="ã‚¢ã‚ºãƒ¼ãƒ«ãƒ¬ãƒ¼ãƒ³">ã‚¢ã‚ºãƒ¼ãƒ«ãƒ¬ãƒ¼ãƒ³</option>
                        <option value="ãƒ˜ãƒ–ãƒãƒ³">ãƒ˜ãƒ–ãƒ³ãƒãƒ¼ãƒ³ã‚ºãƒ¬ãƒƒãƒ‰</option>
                        <option value="DQã‚¦ã‚©ãƒ¼ã‚¯">ãƒ‰ãƒ©ã‚´ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆã‚¦ã‚©ãƒ¼ã‚¯</option>
                        <option value="ç™½çŒ«">ç™½çŒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>

                <div class="form-group" id="customGameGroup" style="display: none;">
                    <label for="customGame">ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›</label>
                    <input type="text" id="customGame" placeholder="ä¾‹: ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ã‚¯">
                </div>

                <div class="form-group">
                    <label for="targetName">ç‹™ã£ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©/æ­¦å™¨å <span class="optional">(ä»»æ„)</span></label>
                    <input type="text" id="targetName" placeholder="ä¾‹: é«˜å‚éº—å¥ˆã€è‰è–™ã®å‰£">
                </div>

                <div class="form-group">
                    <label for="gachaTitle">ã‚¬ãƒãƒ£ã‚¿ã‚¤ãƒˆãƒ« <span class="optional">(ä»»æ„)</span></label>
                    <input type="text" id="gachaTitle" placeholder="ä¾‹: éŸ¿ã‘!ãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ã‚³ãƒ©ãƒœã€æ­£æœˆã‚¬ãƒãƒ£">
                </div>

                <div class="form-group">
                    <label for="gachaDeadline">ã‚¬ãƒãƒ£æœŸé™ï¼ˆæ—¥ä»˜ï¼‰ <span class="optional">(ä»»æ„)</span></label>
                    <input type="date" id="gachaDeadline" min="">
                </div>

                <div class="form-group">
                    <label for="gachaDeadlineTime">ã‚¬ãƒãƒ£æœŸé™ï¼ˆæ™‚åˆ»ï¼‰ <span class="optional">(ä»»æ„)</span></label>
                    <input type="time" id="gachaDeadlineTime" value="23:59">
                </div>

                <div class="form-group">
                    <label for="birthdate">ç”Ÿå¹´æœˆæ—¥ <span class="optional">(ä»»æ„)</span></label>
                    <input type="date" id="birthdate" max="2010-12-31">
                </div>

                <div class="form-group">
                    <label for="zodiac">æ˜Ÿåº§ <span class="optional">(ä»»æ„)</span></label>
                    <select id="zodiac">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ç‰¡ç¾Šåº§">ç‰¡ç¾Šåº§</option>
                        <option value="ç‰¡ç‰›åº§">ç‰¡ç‰›åº§</option>
                        <option value="åŒå­åº§">åŒå­åº§</option>
                        <option value="èŸ¹åº§">èŸ¹åº§</option>
                        <option value="ç…å­åº§">ç…å­åº§</option>
                        <option value="ä¹™å¥³åº§">ä¹™å¥³åº§</option>
                        <option value="å¤©ç§¤åº§">å¤©ç§¤åº§</option>
                        <option value="è åº§">è åº§</option>
                        <option value="å°„æ‰‹åº§">å°„æ‰‹åº§</option>
                        <option value="å±±ç¾Šåº§">å±±ç¾Šåº§</option>
                        <option value="æ°´ç“¶åº§">æ°´ç“¶åº§</option>
                        <option value="é­šåº§">é­šåº§</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bloodType">è¡€æ¶²å‹ <span class="optional">(ä»»æ„)</span></label>
                    <select id="bloodType">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="Aå‹">Aå‹</option>
                        <option value="Bå‹">Bå‹</option>
                        <option value="Oå‹">Oå‹</option>
                        <option value="ABå‹">ABå‹</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="eto">å¹²æ”¯ <span class="optional">(ä»»æ„)</span></label>
                    <select id="eto">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å­">å­ï¼ˆã­ãšã¿ï¼‰</option>
                        <option value="ä¸‘">ä¸‘ï¼ˆã†ã—ï¼‰</option>
                        <option value="å¯…">å¯…ï¼ˆã¨ã‚‰ï¼‰</option>
                        <option value="å¯">å¯ï¼ˆã†ã•ãï¼‰</option>
                        <option value="è¾°">è¾°ï¼ˆãŸã¤ï¼‰</option>
                        <option value="å·³">å·³ï¼ˆã¸ã³ï¼‰</option>
                        <option value="åˆ">åˆï¼ˆã†ã¾ï¼‰</option>
                        <option value="æœª">æœªï¼ˆã²ã¤ã˜ï¼‰</option>
                        <option value="ç”³">ç”³ï¼ˆã•ã‚‹ï¼‰</option>
                        <option value="é…‰">é…‰ï¼ˆã¨ã‚Šï¼‰</option>
                        <option value="æˆŒ">æˆŒï¼ˆã„ã¬ï¼‰</option>
                        <option value="äº¥">äº¥ï¼ˆã„ã®ã—ã—ï¼‰</option>
                    </select>
                </div>

                <button type="submit">âœ¨ å ã† âœ¨</button>
            </form>
        </div>

        <div class="card loading" id="loading">
            <div class="spinner"></div>
            <p style="text-align: center; color: var(--primary); font-size: 1.2rem;">å ã„ä¸­...</p>
        </div>

        <div class="card result" id="result">
            <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <footer>
            <p>Powered by ã‚¯ãƒˆã¡ã‚ƒã‚“ ğŸ’« å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ </p>
            <p style="margin-top: 10px; font-size: 0.8rem;">è¥¿æ´‹å æ˜Ÿè¡“ãƒ»æ•°ç§˜è¡“ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»å››æŸ±æ¨å‘½ãƒ»ä¹æ˜Ÿæ°—å­¦ãƒ»è¡€æ¶²å‹å ã„ã‚’çµ±åˆ</p>
        </footer>
    </div>

    <script>
        // æ˜Ÿã‚’ç”Ÿæˆ
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // ã‚¬ãƒãƒ£æœŸé™ã®æœ€å°å€¤ã‚’ä»Šæ—¥ã«è¨­å®š
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('gachaDeadline').min = today;

        // ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«é¸æŠæ™‚ã®å‡¦ç†
        document.getElementById('gameTitle').addEventListener('change', function() {
            const customGameGroup = document.getElementById('customGameGroup');
            const customGameInput = document.getElementById('customGame');
            
            if (this.value === 'ãã®ä»–') {
                customGameGroup.style.display = 'block';
                customGameInput.required = true;
            } else {
                customGameGroup.style.display = 'none';
                customGameInput.required = false;
                customGameInput.value = '';
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('fortuneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let gameTitle = document.getElementById('gameTitle').value;
            if (gameTitle === 'ãã®ä»–') {
                gameTitle = document.getElementById('customGame').value;
            }
            
            const targetName = document.getElementById('targetName').value;
            const gachaTitle = document.getElementById('gachaTitle').value;
            const gachaDeadline = document.getElementById('gachaDeadline').value;
            const gachaDeadlineTime = document.getElementById('gachaDeadlineTime').value;
            const birthdate = document.getElementById('birthdate').value;
            const zodiac = document.getElementById('zodiac').value;
            const bloodType = document.getElementById('bloodType').value;
            const eto = document.getElementById('eto').value;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loading').classList.add('show');
            document.getElementById('result').classList.remove('show');

            // å ã„è¨ˆç®—ï¼ˆæ¨¡æ“¬çš„ã«2ç§’å¾Œã«çµæœè¡¨ç¤ºï¼‰
            setTimeout(() => {
                const result = calculateFortune(gameTitle, targetName, gachaTitle, gachaDeadline, gachaDeadlineTime, birthdate, zodiac, bloodType, eto);
                displayResult(result);
                document.getElementById('loading').classList.remove('show');
                document.getElementById('result').classList.add('show');
                
                // çµæœã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 2000);
        });

        function calculateFortune(gameTitle, targetName, gachaTitle, gachaDeadline, gachaDeadlineTime, birthdate, zodiac, bloodType, eto) {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // å›ºå®šã•ã‚ŒãŸçµæœãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const savedKey = `${gameTitle}_${targetName}_${gachaTitle}_${gachaDeadline}`;
            const fixedResult = localStorage.getItem('fixedGachaResult');
            const fixedResultKey = localStorage.getItem('fixedGachaResultKey');
            
            if (fixedResult && fixedResultKey === savedKey) {
                // å›ºå®šã•ã‚ŒãŸçµæœã‚’è¿”ã™
                return JSON.parse(fixedResult);
            }

            // åŸºæœ¬ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’å«ã‚€ï¼‰
            let baseScore = 70 + Math.floor(Math.random() * 20);

            // ç”Ÿå¹´æœˆæ—¥ã«ã‚ˆã‚‹è£œæ­£
            if (birthdate) {
                const birth = new Date(birthdate);
                const birthDay = birth.getDate();
                baseScore += (birthDay % 10);
            }

            // æ˜Ÿåº§ã«ã‚ˆã‚‹è£œæ­£
            if (zodiac) {
                const zodiacBonus = {
                    'ç‰¡ç¾Šåº§': 5, 'ç‰¡ç‰›åº§': 3, 'åŒå­åº§': 7, 'èŸ¹åº§': 4,
                    'ç…å­åº§': 6, 'ä¹™å¥³åº§': 5, 'å¤©ç§¤åº§': 4, 'è åº§': 8,
                    'å°„æ‰‹åº§': 7, 'å±±ç¾Šåº§': 5, 'æ°´ç“¶åº§': 6, 'é­šåº§': 4
                };
                baseScore += (zodiacBonus[zodiac] || 0);
            }

            // è¡€æ¶²å‹ã«ã‚ˆã‚‹è£œæ­£
            if (bloodType) {
                const bloodBonus = { 'Aå‹': 3, 'Bå‹': 5, 'Oå‹': 4, 'ABå‹': 6 };
                baseScore += (bloodBonus[bloodType] || 0);
            }

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåã«ã‚ˆã‚‹è£œæ­£ï¼ˆåå‰ã®æ–‡å­—æ•°ã§é‹æ°—ãŒå¤‰å‹•ï¼‰
            let targetBonus = 0;
            if (targetName) {
                targetBonus = (targetName.length % 5) + 3;
                baseScore += targetBonus;
            }

            // ã‚¬ãƒãƒ£ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ˆã‚‹è£œæ­£
            if (gachaTitle) {
                baseScore += 2;
            }

            // æœ€çµ‚ã‚¹ã‚³ã‚¢èª¿æ•´
            baseScore = Math.min(100, baseScore);

            // æ¨å¥¨ã‚¬ãƒãƒ£å›æ•°ã‚’è¨ˆç®—
            const recommendedPulls = calculateRecommendedPulls(baseScore, targetName);

            // ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ ç”Ÿæˆï¼ˆæœŸé™ã¨æ™‚åˆ»ã‚’è€ƒæ…®ï¼‰
            const luckyTimes = generateLuckyTimes(currentMonth, baseScore, targetName, gachaDeadline, gachaDeadlineTime);

            // å è¡“åˆ¥è§£èª¬ç”Ÿæˆ
            const divinations = generateDivinations(gameTitle, targetName, gachaTitle, zodiac, bloodType, eto, baseScore);

            // ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
            const luckyActions = generateLuckyActions(baseScore, targetName, gachaTitle);

            const result = {
                gameTitle,
                targetName,
                gachaTitle,
                gachaDeadline,
                gachaDeadlineTime,
                score: baseScore,
                recommendedPulls,
                luckyTimes,
                divinations,
                luckyActions,
                timestamp: now.getTime()
            };

            // çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå›ºå®šç”¨ï¼‰
            localStorage.setItem('lastGachaFortune', JSON.stringify(result));
            localStorage.setItem('fixedGachaResult', JSON.stringify(result));
            localStorage.setItem('fixedGachaResultKey', savedKey);

            return result;
        }

        function calculateRecommendedPulls(score, targetName) {
            let pulls = {
                single: 0,
                ten: 0,
                total: 0
            };

            if (score >= 90) {
                pulls.single = Math.floor(Math.random() * 3) + 1; // 1-3å›
                pulls.ten = Math.floor(Math.random() * 2) + 2; // 2-3å›
            } else if (score >= 80) {
                pulls.single = Math.floor(Math.random() * 2) + 1; // 1-2å›
                pulls.ten = Math.floor(Math.random() * 2) + 2; // 2-3å›
            } else if (score >= 70) {
                pulls.single = Math.floor(Math.random() * 2); // 0-1å›
                pulls.ten = Math.floor(Math.random() * 2) + 1; // 1-2å›
            } else {
                pulls.single = 0;
                pulls.ten = 1;
            }

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåãŒã‚ã‚‹å ´åˆã¯å›æ•°ã‚’èª¿æ•´
            if (targetName) {
                pulls.ten += 1;
            }

            pulls.total = pulls.single + (pulls.ten * 10);

            return pulls;
        }

        function generateLuckyTimes(month, score, targetName, deadline, deadlineTime) {
            const times = [];
            const now = new Date();
            const today = now.getDate();
            
            // æœŸé™ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆæ™‚åˆ»ã‚‚è€ƒæ…®ï¼‰
            if (deadline) {
                let deadlineDate = new Date(deadline);
                
                // æ™‚åˆ»ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (deadlineTime) {
                    const [hours, minutes] = deadlineTime.split(':');
                    deadlineDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                } else {
                    deadlineDate.setHours(23, 59, 59, 999);
                }
                
                const diffTime = deadlineDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
                
                if (diffHours <= 0) {
                    // æœŸé™åˆ‡ã‚Œã®å ´åˆã€ä»Šã®æ™‚é–“ä»¥é™ã‹ã‚‰5ã¤ç”Ÿæˆ
                    for (let i = 0; i < 5; i++) {
                        const hour = (now.getHours() + i + 1) % 24;
                        const endHour = (hour + 2) % 24;
                        
                        times.push({
                            rank: i + 1,
                            date: `${month}æœˆ${today}æ—¥`,
                            time: `${hour}:00 - ${endHour}:00`,
                            score: score - (i * 3),
                            special: targetName && i === 0,
                            urgent: true,
                            passed: false
                        });
                    }
                } else if (diffHours <= 24) {
                    // 24æ™‚é–“ä»¥å†…ã®å ´åˆ
                    const hoursAvailable = Math.min(diffHours, 24);
                    const interval = Math.max(1, Math.floor(hoursAvailable / 5));
                    
                    for (let i = 0; i < 5; i++) {
                        const futureTime = new Date(now.getTime() + (interval * i + 1) * 60 * 60 * 1000);
                        if (futureTime > deadlineDate) break;
                        
                        const targetMonth = futureTime.getMonth() + 1;
                        const targetDay = futureTime.getDate();
                        const hour = futureTime.getHours();
                        const endHour = (hour + 2) % 24;
                        
                        times.push({
                            rank: i + 1,
                            date: `${targetMonth}æœˆ${targetDay}æ—¥`,
                            time: `${hour}:00 - ${endHour}:00`,
                            score: score - (i * 3),
                            special: targetName && i === 0,
                            urgent: i === 0,
                            passed: false
                        });
                    }
                } else {
                    // 3æ—¥ä»¥ä¸Šã‚ã‚‹å ´åˆã€æœŸé™å†…ã‹ã‚‰5ã¤é¸å®š
                    const interval = Math.max(1, Math.floor(diffDays / 5));
                    
                    for (let i = 0; i < 5; i++) {
                        let targetDay = new Date(now);
                        targetDay.setDate(targetDay.getDate() + (interval * i) + Math.floor(Math.random() * Math.max(1, interval)));
                        
                        // æœŸé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
                        if (targetDay > deadlineDate) {
                            targetDay = new Date(deadlineDate);
                            targetDay.setHours(targetDay.getHours() - (i * 2));
                        }
                        
                        // éå»ã«ãªã‚‰ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
                        if (targetDay < now) {
                            targetDay = new Date(now);
                            targetDay.setHours(now.getHours() + i + 1);
                        }
                        
                        const targetMonth = targetDay.getMonth() + 1;
                        const targetDayNum = targetDay.getDate();
                        
                        const hour = targetDay.getHours();
                        const endHour = (hour + 2) % 24;
                        
                        let timeScore = score - (i * 3);
                        if (targetName && i === 0) {
                            timeScore += 3;
                        }
                        
                        times.push({
                            rank: i + 1,
                            date: `${targetMonth}æœˆ${targetDayNum}æ—¥`,
                            time: `${hour}:00 - ${endHour}:00`,
                            score: timeScore,
                            special: targetName && i === 0,
                            urgent: false,
                            passed: false
                        });
                    }
                }
            } else {
                // æœŸé™ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆæœªæ¥ã®æ—¥ä»˜ã‹ã‚‰5ã¤ç”Ÿæˆï¼‰
                const daysInMonth = new Date(now.getFullYear(), month, 0).getDate();
                
                for (let i = 0; i < 5; i++) {
                    let day = today + Math.floor(Math.random() * 14) + 1;
                    if (day > daysInMonth) day = day - daysInMonth;
                    
                    const hour = Math.floor(Math.random() * 24);
                    const endHour = (hour + 2) % 24;
                    
                    let timeScore = score - (i * 3);
                    if (targetName && i === 0) {
                        timeScore += 3;
                    }
                    
                    times.push({
                        rank: i + 1,
                        date: `${month}æœˆ${day}æ—¥`,
                        time: `${hour}:00 - ${endHour}:00`,
                        score: timeScore,
                        special: targetName && i === 0,
                        urgent: false,
                        passed: false
                    });
                }
            }
            
            return times;
        }

        function generateDivinations(gameTitle, targetName, gachaTitle, zodiac, bloodType, eto, score) {
            const divinations = [];

            // è¥¿æ´‹å æ˜Ÿè¡“
            let astrology = `${zodiac || 'æ˜Ÿåº§æƒ…å ±ãªã—'}ã®æ–¹ã¯ã€`;
            if (score >= 85) {
                astrology += 'ç¾åœ¨ã€å¹¸é‹ã®æ˜ŸãŒå¼·ãè¼ã„ã¦ã„ã¾ã™ã€‚é‡‘æ˜Ÿã¨æœ¨æ˜Ÿã®è‰¯ã„é…ç½®ã«ã‚ˆã‚Šã€ã‚¬ãƒãƒ£é‹ãŒæœ€é«˜æ½®ã«é”ã—ã¦ã„ã¾ã™ã€‚';
            } else if (score >= 70) {
                astrology += 'é‹æ°—ã¯å®‰å®šã—ã¦ãŠã‚Šã€æœˆã®å½±éŸ¿ã§ç›´æ„ŸãŒå†´ãˆã¦ã„ã¾ã™ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹æ¥µã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚';
            } else {
                astrology += 'é‹æ°—ã¯ç©ã‚„ã‹ã§ã™ãŒã€æ°´æ˜Ÿã®é€†è¡Œã«ã‚ˆã‚Šæ…é‡ã•ãŒå¿…è¦ã§ã™ã€‚ç„¦ã‚‰ãšãƒãƒ£ãƒ³ã‚¹ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ã€‚';
            }
            
            if (gachaTitle && targetName) {
                astrology += `ã€Œ${gachaTitle}ã€ã§ã®ã€Œ${targetName}ã€ã¨ã®ç¸ã¯ã€ç¬¬1å€™è£œã®æ™‚é–“å¸¯ã«æœ€ã‚‚å¼·ã¾ã‚Šã¾ã™ã€‚`;
            } else if (targetName) {
                astrology += `ç‰¹ã«ã€Œ${targetName}ã€ã¨ã®ç¸ã¯ã€ç¬¬1å€™è£œã®æ™‚é–“å¸¯ã«å¼·ã¾ã‚Šã¾ã™ã€‚`;
            } else if (gachaTitle) {
                astrology += `ã€Œ${gachaTitle}ã€ã®æœŸé–“ã¯ã€é‹å‘½ã®æ˜Ÿã®é…ç½®ãŒè‰¯å¥½ã§ã™ã€‚`;
            }
            
            divinations.push({ title: 'ğŸŒŸ è¥¿æ´‹å æ˜Ÿè¡“', content: astrology });

            // æ•°ç§˜è¡“
            let numerology = `ã‚²ãƒ¼ãƒ ã€Œ${gameTitle}ã€ã®æ•°å€¤æ³¢å‹•ã‚’åˆ†æã™ã‚‹ã¨ã€ä»Šæœˆã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼å€¤ãŒé«˜ãã€ç‰¹ã«${generateLuckyNumber()}ã®æ•°å­—ãŒå¹¸é‹ã‚’å‘¼ã³ã¾ã™ã€‚`;
            
            if (gachaTitle) {
                const titleLength = gachaTitle.length;
                numerology += `ã€Œ${gachaTitle}ã€ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¯${titleLength}æ–‡å­—ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå®¿ã£ã¦ãŠã‚Šã€`;
            }
            
            if (targetName) {
                const targetNumber = targetName.length;
                numerology += `ã€Œ${targetName}ã€ã®åå‰ã«ã¯${targetNumber}æ–‡å­—ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå®¿ã£ã¦ãŠã‚Šã€ã“ã®æ•°å­—ã‚’æ„è­˜ã™ã‚‹ã¨å¼•ãå¯„ã›åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚`;
            } else {
                numerology += 'ã“ã®æ•°å­—ã‚’æ„è­˜ã—ã¦ã‚¬ãƒãƒ£ã‚’å¼•ãã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚';
            }
            
            divinations.push({ title: 'ğŸ”¢ æ•°ç§˜è¡“', content: numerology });

            // ã‚¿ãƒ­ãƒƒãƒˆ
            let tarot = '';
            if (gachaTitle && targetName) {
                tarot = `ã€Œ${gachaTitle}ã€ã§ã€Œ${targetName}ã€ã‚’æ±‚ã‚ã‚‹ã‚ãªãŸã«ã¯ã€ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œé‹å‘½ã®è¼ªã€ã¨ã€Œæ‹äººã€ãŒåŒæ™‚ã«å‡ºç¾ã€‚ã“ã‚Œã¯æ¥µã‚ã¦ç¨€ãªå¼·é‹ã®æš—ç¤ºã§ã™ã€‚é¡˜ã„ã¯å¿…ãšå¶ã„ã¾ã™ã€‚`;
            } else if (targetName) {
                tarot = `ã€Œ${targetName}ã€ã‚’æ±‚ã‚ã‚‹ã‚ãªãŸã«ã¯ã€ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œæ‹äººã€ãŒå‡ºç¾ã€‚å¼·ã„ç¸ã¨å¼•ãå¯„ã›ã®åŠ›ãŒåƒã„ã¦ã„ã¾ã™ã€‚é¡˜ã„ãŒç¾å®ŸåŒ–ã™ã‚‹å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„ã§ã™ã€‚`;
            } else if (gachaTitle) {
                tarot = `ã€Œ${gachaTitle}ã€ã®æœŸé–“ã€ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œå¤ªé™½ã€ãŒè¼ã„ã¦ã„ã¾ã™ã€‚æˆåŠŸã¨å–œã³ã®æš—ç¤ºã§ã™ã€‚ç©æ¥µçš„ã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚`;
            } else if (score >= 80) {
                tarot = 'ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œæ˜Ÿã€ãŒç¤ºç¾ã€‚å¸Œæœ›ã¨å¹¸é‹ã®æš—ç¤ºã§ã™ã€‚é¡˜ã„ãŒå¶ã†å¯èƒ½æ€§ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚';
            } else {
                tarot = 'ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œé‹å‘½ã®è¼ªã€ãŒå‡ºç¾ã€‚å¤‰åŒ–ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚æµã‚Œã«èº«ã‚’ä»»ã›ã‚‹ã“ã¨ã§è‰¯ã„çµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚';
            }
            divinations.push({ title: 'ğŸ´ ã‚¿ãƒ­ãƒƒãƒˆå ã„', content: tarot });

            // æ±æ´‹å æ˜Ÿè¡“
            let eastern = '';
            if (eto === 'é…‰') {
                eastern = 'é…‰å¹´ã®æ–¹ã¯ã€ä»Šæœˆã¯ã€Œæ¡ƒèŠ±é‹ã€ãŒå¼·ã¾ã‚‹æ™‚æœŸã§ã™ã€‚ã‚¬ãƒãƒ£ã«ãŠã„ã¦ã‚‚é‹å‘½çš„ãªå‡ºä¼šã„ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ãŒæœŸå¾…ã§ãã¾ã™ã€‚';
            } else if (eto) {
                eastern = `${eto}å¹´ã®æ–¹ã¯ã€ä»Šæœˆã®é‹æ°—ã¯ä¸Šæ˜‡å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚ç‰¹ã«åˆå¾Œã®æ™‚é–“å¸¯ã«è‰¯ã„é‹æ°—ãŒæµã‚Œã¦ã„ã¾ã™ã€‚`;
            } else {
                eastern = 'å››æŸ±æ¨å‘½ã«ã‚ˆã‚‹ã¨ã€ä»Šæœˆã¯ã€Œè²¡é‹ã€ã¨ã€Œæ¡ƒèŠ±é‹ã€ãŒé«˜ã¾ã‚‹æ™‚æœŸã§ã™ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒå‰ã‚’å‘¼ã³ã¾ã™ã€‚';
            }
            
            if (gachaTitle && targetName) {
                eastern += `ã€Œ${gachaTitle}ã€ã§ã®ã€Œ${targetName}ã€ã¨ã®ç¸ã¯ã€å¤©ãŒå®šã‚ãŸé‹å‘½ã§ã™ã€‚æç¤ºã•ã‚ŒãŸæ™‚é–“ã«å¼•ã‘ã°ã€å¿…ãšæ‰‹ã«å…¥ã‚‹ã§ã—ã‚‡ã†ã€‚`;
            } else if (targetName) {
                eastern += `ã€Œ${targetName}ã€ã¨ã®ç¸ã¯å¤©ã‹ã‚‰å®šã‚ã‚‰ã‚ŒãŸã‚‚ã®ã€‚è«¦ã‚ãšã«æŒ‘æˆ¦ã—ç¶šã‘ã‚‹ã“ã¨ã§ã€å¿…ãšæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚`;
            } else if (gachaTitle) {
                eastern += `ã€Œ${gachaTitle}ã€ã®æœŸé–“ã¯ã€å¤©ã®æµã¿ã‚’å—ã‘ã‚„ã™ã„æ™‚æœŸã§ã™ã€‚`;
            }
            
            divinations.push({ title: 'â˜¯ï¸ æ±æ´‹å æ˜Ÿè¡“', content: eastern });

            // è¡€æ¶²å‹å ã„
            const blood = bloodType 
                ? `${bloodType}ã®æ–¹ã¯ã€${getBloodTypeAdvice(bloodType)}`
                : 'è¡€æ¶²å‹æƒ…å ±ãŒã‚ã‚Œã°ã€ã•ã‚‰ã«è©³ç´°ãªé‘‘å®šãŒå¯èƒ½ã§ã™ã€‚';
            divinations.push({ title: 'ğŸ©¸ è¡€æ¶²å‹å ã„', content: blood });

            return divinations;
        }

        function getBloodTypeAdvice(bloodType) {
            const advice = {
                'Aå‹': 'æ…é‡ãªæ€§æ ¼ãŒå‰ã¨å‡ºã¾ã™ã€‚è¨ˆç”»çš„ã«ã‚¬ãƒãƒ£ã‚’å¼•ãã“ã¨ã§ã€é«˜ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’å¼•ãå½“ã¦ã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚',
                'Bå‹': 'ç›´æ„ŸåŠ›ãŒå†´ãˆã¦ã„ã¾ã™ã€‚ã€Œå¼•ããŸã„ã€ã¨æ€ã£ãŸç¬é–“ãŒãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚è¿·ã‚ãšè¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚',
                'Oå‹': 'å¤§èƒ†ã•ãŒå¹¸é‹ã‚’å‘¼ã³ã¾ã™ã€‚æ€ã„åˆ‡ã£ã¦ã‚¬ãƒãƒ£ã«æŒ‘æˆ¦ã™ã‚‹ã“ã¨ã§ã€äºˆæƒ³ä»¥ä¸Šã®çµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚',
                'ABå‹': 'ç‹¬ç‰¹ã®æ„Ÿæ€§ãŒæ­¦å™¨ã§ã™ã€‚ä»–ã®äººãŒå¼•ã‹ãªã„æ™‚é–“å¸¯ã«å¼•ãã“ã¨ã§ã€ãƒ¬ã‚¢ãªçµæœã‚’å¾—ã‚„ã™ããªã‚Šã¾ã™ã€‚'
            };
            return advice[bloodType] || '';
        }

        function generateLuckyNumber() {
            const numbers = [3, 7, 8, 9, 11, 22, 33];
            return numbers[Math.floor(Math.random() * numbers.length)];
        }

        function generateLuckyActions(score, targetName, gachaTitle) {
            const actions = [
                'ã‚¬ãƒãƒ£ã‚’å¼•ãå‰ã«ã€æ·±å‘¼å¸ã‚’3å›ã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¾ã—ã‚‡ã†',
                'ç”»é¢ã‚’ç¶ºéº—ã«æ‹­ã„ã¦ã€é‹æ°—ã®é€šã‚Šé“ã‚’æ•´ãˆã¾ã—ã‚‡ã†',
                'å¥½ããªéŸ³æ¥½ã‚’è´ã„ã¦ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ°—æŒã¡ã‚’é«˜ã‚ã¾ã—ã‚‡ã†',
                'éƒ¨å±‹ã®æƒé™¤ã‚’ã—ã¦ã€é‹æ°—ã®æµã‚Œã‚’è‰¯ãã—ã¾ã—ã‚‡ã†',
                'ç¥ç¤¾ã‚„ãŠå¯ºã®ç”»åƒã‚’è¦‹ã¦ã€å¿ƒã‚’è½ã¡ç€ã‘ã¾ã—ã‚‡ã†'
            ];

            if (score >= 85) {
                actions.push('ä»Šã¯æœ€é«˜ã®é‹æ°—ã§ã™ã€‚è‡ªä¿¡ã‚’æŒã£ã¦ã‚¬ãƒãƒ£ã«è‡¨ã¿ã¾ã—ã‚‡ã†');
            }

            if (gachaTitle && targetName) {
                actions.push(`ã€Œ${gachaTitle}ã€ã®ã€Œ${targetName}ã€ã®åå‰ã‚’3å›å”±ãˆã¦ã‹ã‚‰å¼•ãã¾ã—ã‚‡ã†`);
                actions.push(`ã€Œ${targetName}ã€ã®ç”»åƒã‚’å¾…ã¡å—ã‘ã«ã—ã¦ã€å¼•ãå¯„ã›ãƒ‘ãƒ¯ãƒ¼ã‚’é«˜ã‚ã¾ã—ã‚‡ã†`);
                actions.push(`ã€Œ${gachaTitle}ã€ã®ãƒãƒŠãƒ¼ã‚’è¦‹ã¤ã‚ã¦ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¼·ãæŒã¡ã¾ã—ã‚‡ã†`);
            } else if (targetName) {
                actions.push(`ã€Œ${targetName}ã€ã®åå‰ã‚’3å›å”±ãˆã¦ã‹ã‚‰å¼•ãã¾ã—ã‚‡ã†`);
                actions.push(`ã€Œ${targetName}ã€ã®ç”»åƒã‚’å¾…ã¡å—ã‘ã«ã—ã¦ã€å¼•ãå¯„ã›ãƒ‘ãƒ¯ãƒ¼ã‚’é«˜ã‚ã¾ã—ã‚‡ã†`);
            } else if (gachaTitle) {
                actions.push(`ã€Œ${gachaTitle}ã€ã®æˆåŠŸã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ãªãŒã‚‰å¼•ãã¾ã—ã‚‡ã†`);
            }

            return actions;
        }

        // PDFå‡ºåŠ›æ©Ÿèƒ½ï¼ˆç”»åƒä»˜ãï¼‰
        async function downloadPDF() {
            const result = JSON.parse(localStorage.getItem('lastGachaFortune'));
            if (!result) {
                alert('å ã„çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                // HTML to Canvas ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã¨ã—ã¦å‡ºåŠ›
                const resultDiv = document.getElementById('result');
                
                // html2canvasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰
                if (!window.html2canvas) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }

                // çµæœå…¨ä½“ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
                const canvas = await html2canvas(resultDiv, {
                    backgroundColor: '#FAF7FB',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // Canvasã‚’ç”»åƒã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `ã‚¬ãƒãƒ£å ã„çµæœ_${result.gameTitle}_${timestamp}.png`;
                link.href = imgData;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert('ç”»åƒã¨ã—ã¦çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
                
            } catch (error) {
                console.error('ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                alert('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ãŸãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                downloadTextFallback(result);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadTextFallback(result) {
            let pdfText = '='.repeat(60) + '\n';
            pdfText += 'ã‚¬ãƒãƒ£å ã„çµæœ\n';
            pdfText += 'by ã‚¯ãƒˆã¡ã‚ƒã‚“ - å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ \n';
            pdfText += '='.repeat(60) + '\n\n';
            
            // åŸºæœ¬æƒ…å ±
            pdfText += `ã‚²ãƒ¼ãƒ : ${result.gameTitle}\n`;
            if (result.gachaTitle) {
                pdfText += `ã‚¬ãƒãƒ£ã‚¿ã‚¤ãƒˆãƒ«: ${result.gachaTitle}\n`;
            }
            if (result.targetName) {
                pdfText += `ç‹™ã„: ${result.targetName}\n`;
            }
            if (result.gachaDeadline) {
                const deadline = new Date(result.gachaDeadline);
                const deadlineStr = `${deadline.getMonth() + 1}æœˆ${deadline.getDate()}æ—¥`;
                const timeStr = result.gachaDeadlineTime || '23:59';
                pdfText += `æœŸé™: ${deadlineStr} ${timeStr}ã¾ã§\n`;
            }
            pdfText += '\n' + '-'.repeat(60) + '\n\n';
            
            // ç·åˆé‹æ°—
            pdfText += `ã€ç·åˆé‹æ°—ã€‘ ${result.score}ç‚¹\n\n`;
            
            // æ¨å¥¨ã‚¬ãƒãƒ£å›æ•°
            pdfText += 'ã€æ¨å¥¨ã‚¬ãƒãƒ£å›æ•°ã€‘\n';
            pdfText += `  å˜ç™ºã‚¬ãƒãƒ£: ${result.recommendedPulls.single}å›\n`;
            pdfText += `  10é€£ã‚¬ãƒãƒ£: ${result.recommendedPulls.ten}å›\n`;
            pdfText += `  åˆè¨ˆ: ${result.recommendedPulls.total}é€£\n\n`;
            pdfText += '-'.repeat(60) + '\n\n';
            
            // ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ 
            pdfText += 'ã€æœ€é©ã‚¬ãƒãƒ£æ™‚åˆ»ã€‘\n\n';
            result.luckyTimes.forEach(time => {
                const badges = [];
                if (time.special) badges.push('ç‰¹åˆ¥');
                if (time.urgent) badges.push('ç·Šæ€¥');
                if (time.passed) badges.push('çµ‚äº†');
                const badgeText = badges.length > 0 ? ` [${badges.join(', ')}]` : '';
                
                pdfText += `ç¬¬${time.rank}å€™è£œ${badgeText}\n`;
                pdfText += `  æ—¥æ™‚: ${time.date} ${time.time}\n`;
                pdfText += `  é‹æ°—ã‚¹ã‚³ã‚¢: ${time.score}ç‚¹\n\n`;
            });
            pdfText += '-'.repeat(60) + '\n\n';
            
            // å è¡“è§£èª¬
            pdfText += 'ã€å è¡“åˆ¥è§£èª¬ã€‘\n\n';
            result.divinations.forEach(div => {
                pdfText += div.title + '\n';
                pdfText += div.content + '\n\n';
            });
            pdfText += '-'.repeat(60) + '\n\n';
            
            // ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            pdfText += 'ã€ã‚¬ãƒãƒ£å‰ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘\n\n';
            result.luckyActions.forEach((action, index) => {
                pdfText += `${index + 1}. ${action}\n`;
            });
            pdfText += '\n' + '='.repeat(60) + '\n';
            pdfText += 'Powered by ã‚¯ãƒˆã¡ã‚ƒã‚“ - å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ \n';
            pdfText += '='.repeat(60) + '\n';
            
            // Blobã¨ã—ã¦ä¿å­˜
            const blob = new Blob([pdfText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().split('T')[0];
            a.download = `ã‚¬ãƒãƒ£å ã„_${result.gameTitle}_${timestamp}.txt`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetFortune() {
            if (confirm('çµæœã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ãå ã„ç›´ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåŒã˜æ¡ä»¶ã§ã‚‚é•ã†çµæœãŒå‡ºã¾ã™ï¼‰')) {
                localStorage.removeItem('fixedGachaResult');
                localStorage.removeItem('fixedGachaResultKey');
                localStorage.removeItem('lastGachaFortune');
                alert('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ã‚‚ã†ä¸€åº¦å ã„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                location.reload();
            }
        }

        function displayResult(result) {
            const resultDiv = document.getElementById('result');
            
            let html = `
                <div class="lucky-time">
                    <h2>ğŸ¯ ${result.gameTitle} ã®æœ€é©ã‚¬ãƒãƒ£æ™‚åˆ»</h2>
            `;

            if (result.gachaTitle) {
                html += `<div style="margin: 10px 0; font-size: 1.2rem; font-weight: 700; color: #FF6B6B;">ğŸ“… ${result.gachaTitle}</div>`;
            }

            if (result.gachaDeadline) {
                const deadline = new Date(result.gachaDeadline);
                const deadlineStr = `${deadline.getMonth() + 1}æœˆ${deadline.getDate()}æ—¥`;
                const timeStr = result.gachaDeadlineTime || '23:59';
                html += `<div style="margin: 10px 0; font-size: 1rem; color: #FF4500;">â° æœŸé™: ${deadlineStr} ${timeStr}ã¾ã§</div>`;
            }

            if (result.targetName) {
                html += `<div style="margin: 15px 0; font-size: 1.1rem; font-weight: 600;">ğŸ¯ ç‹™ã„: ${result.targetName}</div>`;
            }

            html += `<div class="score">ç·åˆé‹æ°—: ${result.score}ç‚¹</div>`;

            // æ¨å¥¨ã‚¬ãƒãƒ£å›æ•°ã‚’è¡¨ç¤º
            html += `
                <div style="background: rgba(255, 255, 255, 0.3); padding: 20px; border-radius: 10px; margin: 20px 0; backdrop-filter: blur(10px);">
                    <h3 style="margin-bottom: 15px; font-size: 1.2rem;">ğŸ’« æ¨å¥¨ã‚¬ãƒãƒ£å›æ•°</h3>
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; margin-bottom: 5px;">å˜ç™ºã‚¬ãƒãƒ£</div>
                            <div style="font-size: 2rem; font-weight: 700;">${result.recommendedPulls.single}å›</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; margin-bottom: 5px;">10é€£ã‚¬ãƒãƒ£</div>
                            <div style="font-size: 2rem; font-weight: 700;">${result.recommendedPulls.ten}å›</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; margin-bottom: 5px;">åˆè¨ˆ</div>
                            <div style="font-size: 2rem; font-weight: 700;">${result.recommendedPulls.total}é€£</div>
                        </div>
                    </div>
                </div>
            `;

            // éå»ã®æ™‚é–“å¸¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const now = new Date();
            let validTimes = result.luckyTimes.filter(time => !time.passed);
            
            // å…¨ã¦éå»ã®å ´åˆã¯å†è¨ˆç®—ãŒå¿…è¦
            if (validTimes.length === 0) {
                html += `
                    <div style="background: #FFF3CD; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #FFA500;">
                        <p style="color: #856404; margin: 0;">âš ï¸ æç¤ºã•ã‚ŒãŸæ™‚é–“ãŒéãã¾ã—ãŸã€‚å†åº¦å ã„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                validTimes = result.luckyTimes; // è¡¨ç¤ºã¯å…¨ã¦è¡¨ç¤º
            }

            result.luckyTimes.forEach(time => {
                let badges = '';
                let timeStyle = '';
                
                if (time.passed) {
                    badges += '<span style="background: #999; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px;">â°çµ‚äº†</span>';
                    timeStyle = 'opacity: 0.5;';
                } else {
                    if (time.special) {
                        badges += '<span style="background: #FF4500; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px;">âœ¨ç‰¹åˆ¥</span>';
                    }
                    if (time.urgent) {
                        badges += '<span style="background: #DC143C; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px;">ğŸ”¥ç·Šæ€¥</span>';
                    }
                }
                
                html += `
                    <div class="time-slot" style="${timeStyle}">
                        <h3>ç¬¬${time.rank}å€™è£œ ${badges}</h3>
                        <p>${time.date} ${time.time}</p>
                        <div style="margin-top: 10px; font-size: 0.9rem;">é‹æ°—ã‚¹ã‚³ã‚¢: ${time.score}ç‚¹</div>
                    </div>
                `;
            });

            html += '</div>';

            // å¯æ„›ã„å¥³ã®å­ã®ç”»åƒã‚’è¡¨ç¤ºï¼ˆç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            // é‹æ°—ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦ç•°ãªã‚‹å¯æ„›ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¡¨ç¤º
            const imageDesigns = [
                { bg: 'FFB6C1', text: '8B4789', emoji: 'ğŸ’–', title: 'æ‹æ„›é‹ä¸Šæ˜‡', subtitle: 'ç´ æ•µãªå‡ºä¼šã„' },
                { bg: 'E6D5E8', text: '8B4789', emoji: 'ğŸŒ¸', title: 'é‹æ°—æœ€é«˜', subtitle: 'å¹¸é‹ã®å¥³ç¥' },
                { bg: 'FFE4E1', text: '8B4789', emoji: 'âœ¨', title: 'ã‚¬ãƒãƒ£é‹UP', subtitle: 'SSRç¢ºå®š' },
                { bg: 'FFF0F5', text: '8B4789', emoji: 'ğŸ’«', title: 'å¤§å‰', subtitle: 'é¡˜ã„å¶ã†' },
                { bg: 'FFDAB9', text: '8B4789', emoji: 'ğŸ€', title: 'æœ€å¼·é‹', subtitle: 'å¥‡è·¡ã®å¼•ã' }
            ];
            
            const designIndex = result.score % imageDesigns.length;
            const design = imageDesigns[designIndex];
            
            // SVGã§å¯æ„›ã„ã‚¤ãƒ©ã‚¹ãƒˆé¢¨ã®ç”»åƒã‚’ç”Ÿæˆï¼ˆç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            const svgImage = `data:image/svg+xml,${encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="600" height="800" viewBox="0 0 600 800">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#${design.bg};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFE4E1;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="600" height="800" fill="url(#grad)"/>
                    <circle cx="300" cy="200" r="80" fill="#FFF" opacity="0.3"/>
                    <circle cx="450" cy="350" r="60" fill="#FFF" opacity="0.2"/>
                    <circle cx="150" cy="500" r="70" fill="#FFF" opacity="0.25"/>
                    <text x="300" y="400" font-family="Arial" font-size="120" text-anchor="middle" fill="#${design.text}">${design.emoji}</text>
                    <text x="300" y="480" font-family="Arial" font-size="42" font-weight="bold" text-anchor="middle" fill="#${design.text}">${design.title}</text>
                    <text x="300" y="530" font-family="Arial" font-size="32" text-anchor="middle" fill="#${design.text}">${design.subtitle}</text>
                    <rect x="150" y="600" width="300" height="4" rx="2" fill="#${design.text}" opacity="0.3"/>
                    <text x="300" y="670" font-family="Arial" font-size="24" text-anchor="middle" fill="#${design.text}">é‹æ°—ã‚¹ã‚³ã‚¢: ${result.score}ç‚¹</text>
                </svg>
            `)}`;
            
            html += `
                <div class="lucky-girl">
                    <h3>âœ¨ é‹æ°—ä¸Šæ˜‡ä¸­ï¼å¹¸é‹ã®å¥³ç¥ãŒã‚ãªãŸã‚’è¦‹å®ˆã£ã¦ã„ã¾ã™ âœ¨</h3>
                    <img src="${svgImage}" alt="å¹¸é‹ã®å¥³ç¥" loading="lazy" style="border-radius: 20px; box-shadow: 0 20px 60px rgba(139, 71, 137, 0.3); max-width: 100%; height: auto;">
                    <p>ã“ã®å¥³ç¥ã®ã‚ˆã†ãªç´ æ•µãªå¥³æ€§ã¨ã®å‡ºä¼šã„ãŒã€ã‚‚ã†ã™ãè¨ªã‚Œã¾ã™ã€‚<br>ãŠå®ˆã‚Šã‚’å¤§åˆ‡ã«ã€ç¬‘é¡”ã‚’å¿˜ã‚Œãšã«éã”ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;

            result.divinations.forEach(div => {
                html += `
                    <div class="divination-section">
                        <h3>${div.title}</h3>
                        <p>${div.content}</p>
                    </div>
                `;
            });

            html += `
                <div class="lucky-action">
                    <h3>âœ¨ ã‚¬ãƒãƒ£å‰ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <ul>
            `;

            result.luckyActions.forEach(action => {
                html += `<li>${action}</li>`;
            });

            html += `
                    </ul>
                </div>
            `;

            // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            html += `
                <button class="download-pdf-btn" onclick="downloadPDF()">
                    ğŸ“¸ ã“ã®çµæœã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            `;

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            html += `
                <button class="download-pdf-btn" onclick="resetFortune()" style="background: linear-gradient(135deg, #DC143C, #FF6347); margin-top: 15px;">
                    ğŸ”„ çµæœã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ãå ã„ç›´ã™ï¼‰
                </button>
            `;

            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
